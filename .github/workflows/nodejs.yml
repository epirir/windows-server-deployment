name: CI/CD Pipeline

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '16'

      - name: Install dependencies
        run: npm install

      - name: Run tests
        run: npm test

      - name: Install WinSCP
        run: |
          Invoke-WebRequest -Uri "https://winscp.net/download/WinSCP-5.17.10-Setup.exe" -OutFile "$env:USERPROFILE\WinSCP-Setup.exe"
          Start-Process -FilePath "$env:USERPROFILE\WinSCP-Setup.exe" -ArgumentList "/S" -Wait

      - name: Transfer files to Windows Server using WinSCP
        run: |
          # Define the WinSCP script to upload files
          $script = @'
          option batch abort
          option confirm off
          open sftp://${{ secrets.WINDOWS_SERVER_USER }}:${{ secrets.WINDOWS_SERVER_PASSWORD }}@${{ secrets.WINDOWS_SERVER_IP }}
          put -r ./* /C:/Aplications/
          exit
          '@

          # Save the script to a temporary file
          $scriptPath = "$env:USERPROFILE\winscp-script.txt"
          $script | Set-Content -Path $scriptPath

          # Execute WinSCP with the script
          & "C:\Program Files (x86)\WinSCP\WinSCP.com" /script=$scriptPath

      - name: Restart IIS on the remote server
        run: |
          Invoke-WebRequest -Uri "http://${{ secrets.WINDOWS_SERVER_IP }}/api/restart" -UseBasicParsing